# Note: for now, defaults are for documentation purposes only.
# see https://github.com/mojolicious/json-validator/issues/158
---
$comment: 'Note that all parameters are parsed internally from the request URI as strings, so all type checks here use strings. When a query parameter is used more than once, its values are parsed as an arrayref. See ../modules/Conch::Plugin::JSONValidator#validate_query_params. For now, defaults are for documentation purposes only. see https://github.com/mojolicious/json-validator/issues/158'
$schema: 'http://json-schema.org/draft-07/schema#'
definitions:
  boolean_string:
    type: string
    enum: [ '0', '1' ]
  boolean_string_default_false:
    type: string
    enum: [ '0', '1' ]
    default: '0'
  boolean_string_default_true:
    type: string
    enum: [ '0', '1' ]
    default: '1'
  boolean_string_or_flag:
    description: '"?foo" and "?foo=1" are true; "?foo=0" is false'
    oneOf:
      - const: ''
      - $ref: '#/definitions/boolean_string'
  non_negative_integer_string:
    description: see common.yaml#/definitions/non_negative_integer
    type: string
    pattern: '^[0-9]+$'

  RevokeUserTokens:
    allOf:
      - type: object
        additionalProperties: false
        properties:
          login_only:
            $ref: '#/definitions/boolean_string_default_false'
          api_only:
            $ref: '#/definitions/boolean_string_default_false'
          send_mail:
            $ref: '#/definitions/boolean_string_default_true'
      - not:
          type: object
          required:
            - login_only
            - api_only
          properties:
            login_only:
              const: '1'
            api_only:
              const: '1'
  ChangePassword:
    type: object
    additionalProperties: false
    properties:
      clear_tokens:
        type: string
        enum:
          - none
          - login_only
          - all
        default: login_only
  DeactivateUser:
    $ref: '#/definitions/ChangePassword'
  ResetUserPassword:
    type: object
    additionalProperties: false
    properties:
      clear_tokens:
        type: string
        enum:
          - none
          - login_only
          - all
        default: login_only
      send_mail:
        $ref: '#/definitions/boolean_string_default_true'
  NotifyUsers:
    description: used for operations where email can optionally be sent
    type: object
    additionalProperties: false
    properties:
      send_mail:
        $ref: '#/definitions/boolean_string_default_true'
  GetDeviceByAttribute:
    type: object
    minProperties: 1
    maxProperties: 1
    properties:
      hostname:
        type: string
      mac:
        $ref: common.yaml#/definitions/macaddr
      ipaddr:
        $ref: common.yaml#/definitions/ipaddr
      link:
        type: string
        format: uri
    propertyNames:
      $ref: common.yaml#/definitions/device_setting_key
    additionalProperties:
      type: string
  GetValidationState:
    type: object
    additionalProperties: true  # may be used at the same time as other schemas
    properties:
      status:
        oneOf:
          - $ref: common.yaml#/definitions/validation_status
          - type: array
            uniqueItems: true
            minItems: 2
            items:
              $ref: common.yaml#/definitions/validation_status
  SetPhase:
    type: object
    additionalProperties: false
    properties:
      rack_only:
        $ref: '#/definitions/boolean_string_default_false'
  GetBuilds:
    type: object
    properties:
      started:
        $ref: '#/definitions/boolean_string'
      completed:
        $ref: '#/definitions/boolean_string'
    not:
      required:
        - started
        - completed
      properties:
        started:
          const: 0
        completed:
          const: 1
  WithDeviceRackData:
    type: object
    additionalProperties: true  # overlays with other schemas
    properties:
      with_device_health:
        $ref: '#/definitions/boolean_string_or_flag'
      with_device_phases:
        $ref: '#/definitions/boolean_string_or_flag'
      with_rack_phases:
        $ref: '#/definitions/boolean_string_or_flag'
  FindDevice:
    type: object
    additionalProperties: true  # may be used at the same time as other schemas
    properties:
      phase_earlier_than:
        oneOf:
          - const: ''
          - $ref: common.yaml#/definitions/device_phase
  BuildDevices:
    type: object
    additionalProperties: true  # may be used at the same time as other schemas
    properties:
      health:
        oneOf:
          - $ref: common.yaml#/definitions/device_health
          - type: array
            uniqueItems: true
            minItems: 2
            items:
              $ref: common.yaml#/definitions/device_health
      phase:
        oneOf:
          - $ref: common.yaml#/definitions/device_phase
          - type: array
            uniqueItems: true
            minItems: 2
            items:
              $ref: common.yaml#/definitions/device_phase
      active_minutes:
        $ref: '#/definitions/non_negative_integer_string'
      ids_only:
        $ref: '#/definitions/boolean_string_default_false'
      serials_only:
        $ref: '#/definitions/boolean_string_default_false'
    allOf:
      - not:
          type: object
          required: [ ids_only, serials_only ]
          properties:
            ids_only:
              const: '1'
            serials_only:
              const: '1'
      - not:
          type: object
          required: [ phase_earlier_than, phase ]
  BuildRacks:
    type: object
    additionalProperties: false
    properties:
      phase:
        oneOf:
          - $ref: common.yaml#/definitions/device_phase
          - type: array
            uniqueItems: true
            minItems: 2
            items:
              $ref: common.yaml#/definitions/device_phase
      ids_only:
        $ref: '#/definitions/boolean_string_default_false'
  ProcessDeviceReport:
    type: object
    additionalProperties: false
    properties:
      no_save_db:
        $ref: '#/definitions/boolean_string_default_false'
  HardwareProductSpecification:
    type: object
    additionalProperties: false
    required:
      - path
    properties:
      path:
        type: string
        format: json-pointer

# vim: set sts=2 sw=2 et :
